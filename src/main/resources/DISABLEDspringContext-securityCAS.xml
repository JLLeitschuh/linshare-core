<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:security="http://www.springframework.org/schema/security"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.1.xsd">

    <bean id="filterChainProxy" class="org.springframework.security.util.FilterChainProxy">
        <property name="filterInvocationDefinitionSource">
            <value>
                   CONVERT_URL_TO_LOWER_CASE_BEFORE_COMPARISON
                   PATTERN_TYPE_APACHE_ANT
                   /=httpSessionIntegrationFilter,rememberMeProcessingFilter
                   /assets/**=#NONE#
                   /applet/**=#NONE#
                   /css/**=#NONE#
                   /images/**=#NONE#
                   /videos/**=#NONE#
                   /**/help/**=#NONE#
                   /**/password/**=#NONE#
                   /**/*.js=#NONE#
                   /**/*.css=#NONE#
                   /**/*.swf=#NONE#
                   /**/en=httpSessionIntegrationFilter,rememberMeProcessingFilter
                   /**/fr=httpSessionIntegrationFilter,rememberMeProcessingFilter
                   /**/nl=httpSessionIntegrationFilter,rememberMeProcessingFilter
                   /download/**=#NONE#
                   /**/download.passwordpopup.formpassword=#NONE#
                   /download.downloadthemall/**=#NONE#
                   /localDecrypt/**=#NONE#
                   /documentrestservice/**=httpSessionIntegrationFilter,basicProcessingFilter,basicExceptionTranslationFilter ,filterSecurityInterceptor
                   /userrestservice/**=httpSessionIntegrationFilter,basicProcessingFilter,basicExceptionTranslationFilter ,filterSecurityInterceptor
                   /sharerestservice/**=httpSessionIntegrationFilter,basicProcessingFilter,basicExceptionTranslationFilter ,filterSecurityInterceptor
                   /index.form=httpSessionIntegrationFilter
                   /sso=httpSessionIntegrationFilter,casExceptionTranslationFilter,filterSecurityInterceptor
                   /j_security_check=httpSessionIntegrationFilter,authenticationProcessingFilter
                   /j_spring_cas_security_check=httpSessionIntegrationFilter,casProcessingFilter
                   /**=httpSessionIntegrationFilter,exceptionTranslationFilter,casSingleSignOutFilter,logoutFilter,rememberMeProcessingFilter,filterSecurityInterceptor
            </value>
        </property>
    </bean>

       <!--         FILTERS DEFINITION           -->
    <bean id="httpSessionIntegrationFilter"
             class="org.springframework.security.context.HttpSessionContextIntegrationFilter"/>

    <bean id="authenticationProcessingFilter" class="org.linagora.linShare.auth.DomainAuthenticationProcessingFilter">
        <property name="usernameParameter" value="login"/>
        <property name="passwordParameter" value="password"/>
        <property name="defaultTargetUrl" value="/"/>
        <property name="filterProcessesUrl" value="/j_security_check"/>
        <property name="authenticationFailureUrl" value="/?login_error=1"/>
        <property name="exceptionMappings">
  			<props>
    			<prop key="org.linagora.linShare.auth.exceptions.BadDomainException">/?login_error=2</prop>
  			</props>
		</property>
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="rememberMeServices" ref="rememberMeService"/>
    </bean>

    <bean id="exceptionTranslationFilter" class="org.springframework.security.ui.ExceptionTranslationFilter">
        <property name="authenticationEntryPoint" ref="authenticationEntryPoint"/>
    </bean>

    <bean id="authenticationEntryPoint" class="org.springframework.security.ui.webapp.AuthenticationProcessingFilterEntryPoint">
        <property name="loginFormUrl" value="/"/>
    </bean>

    <bean id="logoutFilter" class="org.springframework.security.ui.logout.LogoutFilter">
        <constructor-arg value="/"/>
        <constructor-arg>
            <list>
				<ref bean="rememberMeService"/>
                <bean class="org.springframework.security.ui.logout.SecurityContextLogoutHandler"/>
            </list>
        </constructor-arg>
    </bean>

    <bean id="filterSecurityInterceptor" class="org.springframework.security.intercept.web.FilterSecurityInterceptor">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="accessDecisionManager" ref="accessDecisionManager"/>
        <property name="objectDefinitionSource">
            <value>
                CONVERT_URL_TO_LOWER_CASE_BEFORE_COMPARISON
                PATTERN_TYPE_APACHE_ANT
                /**/administration/userconfig*=ROLE_AUTH
                /**/administration/domains=ROLE_SUPERADMIN
                /**/administration/domains/**=ROLE_SUPERADMIN
                /**/administration/**=ROLE_ADMIN
                /**=ROLE_AUTH
            </value>
        </property>
    </bean>

	<!--         REMEMBER-ME SERVICE DEFINITION           -->
	 <bean id="rememberMeAuthenticationProvider" class="org.springframework.security.providers.rememberme.RememberMeAuthenticationProvider">
	 	<property name="key" value="springRocks"/>
	 </bean>
	 
	 <bean id="rememberMeService" class="org.linagora.linShare.view.tapestry.services.impl.LinshareRememberMeServices">
	 	<property name="key" value="springRocks"/>
	 	<property name="userDetailsService" ref="guestAuthProvider" />  
	 	<property name="tokenRepository" ref="cookieRepository"/>
	 	<property name="alwaysRemember" value="false"/>
	 	<constructor-arg ref="cookieRepository"/>
	 </bean>
	
	<bean id="rememberMeProcessingFilter" class="org.springframework.security.ui.rememberme.RememberMeProcessingFilter">
		<property name="rememberMeServices" ref="rememberMeService"/>
		<property name="authenticationManager" ref="authenticationManager"/>
	</bean>


<!--  REST part / Magic lies there -->
		<bean id="basicProcessingFilter" class="org.springframework.security.ui.basicauth.BasicProcessingFilter">
        	<property name="authenticationManager"><ref bean="authenticationManager"/></property>
        	<property name="authenticationEntryPoint"><ref bean="restAuthenticationEntryPoint"/></property>
        </bean>
        
        <bean id="restAuthenticationEntryPoint"
        class="org.springframework.security.ui.basicauth.BasicProcessingFilterEntryPoint">
        	<property name="realmName"><value>Name Of Your Realm</value></property>
        </bean>
        
		<bean id="basicExceptionTranslationFilter" class="org.springframework.security.ui.ExceptionTranslationFilter">
			<property name="authenticationEntryPoint" ref="restAuthenticationEntryPoint"/>
		</bean>
<!--  -->

       <!--       AUTHENTICATION MANAGEMENT      -->
       <!-- Authentication manager -->
    <bean id="authenticationManager" class="org.springframework.security.providers.ProviderManager">
        <property name="providers">
            <list>
            	<ref bean="rememberMeAuthenticationProvider" />
                <ref bean="daoAuthenticationProvider"/>
                <ref bean="domainAuthenticationProvider"/>
            </list>
        </property>
    </bean>
    
     <!-- Domain Authentification -->

       <bean id="domainAuthenticationProvider" class="org.linagora.linShare.auth.DomainAuthProviderDao">
           <property name="ldapQueryService" ref="ldapQueryService"/>
           <property name="userService" ref="userService"/>
           <property name="domainService" ref="domainService"/>
       </bean>

       <!-- DAO Authentification -->
       <bean id="guestAuthProvider" class="org.linagora.linShare.auth.DaoAuthProvider">
           <constructor-arg ref="userFacade"/>
       </bean>

       <bean id="passwordEncoderFactory" class="org.linagora.linShare.auth.PasswordEncoderFactory">
           <constructor-arg value="SHA"/>
       </bean>

       <bean id="daoAuthenticationProvider" class="org.springframework.security.providers.dao.DaoAuthenticationProvider">
           <property name="userDetailsService" ref="guestAuthProvider"/>
           <property name="passwordEncoder">
               <bean factory-bean="passwordEncoderFactory" factory-method="getInstance"/>
           </property>
       </bean>

       <!--     AUTHORIZATIONS MANAGEMENT   -->
       <bean id="accessDecisionManager" class="org.springframework.security.vote.UnanimousBased">
           <property name="decisionVoters">
               <list>
                   <ref bean="roleVoter"/>
               </list>
           </property>
       </bean>

       <bean id="roleVoter" class="org.springframework.security.vote.RoleVoter"/>
       
       
       <!-- **** extra configuration CAS sso ***** -->

       <bean id="casAuthProvider" class="org.linagora.linShare.auth.DaoCasAuthProvider">
       		<property name="userDetailsProvider" ref="userDetailsProvider"/>
       </bean>
       <bean id="userDetailsProvider" class="org.linagora.linShare.auth.UserDetailsProvider">
       		<property name="userService" ref="userService"/>
       </bean>
       
        <bean id="casAuthenticationProvider"
       	class="org.springframework.security.providers.cas.CasAuthenticationProvider">
       	<property name="userDetailsService" ref="casAuthProvider" />
       	<property name="serviceProperties" ref="serviceProperties" />
       	<property name="ticketValidator">
       		<bean
       			class="org.jasig.cas.client.validation.Cas20ServiceTicketValidator">
       			<constructor-arg index="0"
       				value="${sso.cas.url}" />
       		</bean>
       	</property>
       	<property name="key" value="cas_id_auth_provider_linshare" />
       </bean>
       
        <bean id="casAuthenticationManager"
       	class="org.springframework.security.providers.ProviderManager">
       	<property name="providers">
       		<list>
       			<ref bean="casAuthenticationProvider" />
       		</list>
       	</property>
       </bean>

       <bean id="casExceptionTranslationFilter"
       	class="org.springframework.security.ui.ExceptionTranslationFilter">
       	<property name="authenticationEntryPoint"
       		ref="casProcessingFilterEntryPoint" />
       </bean>
       
        <bean id="casProcessingFilterEntryPoint"
       	class="org.springframework.security.ui.cas.CasProcessingFilterEntryPoint">
       	<property name="loginUrl"
       		value="${sso.cas.url.login}" />
       	<property name="serviceProperties" ref="serviceProperties" />
       </bean>
       
        <bean id="serviceProperties"
       	class="org.springframework.security.ui.cas.ServiceProperties">
       	<property name="service"
       		value="${sso.cas.url.serviceId}" />
       	<property name="sendRenew" value="false" />
       </bean>

       <bean id="casProcessingFilter"
       	class="org.springframework.security.ui.cas.CasProcessingFilter">
       	<property name="authenticationManager"
       		ref="casAuthenticationManager" />
       	<property name="authenticationFailureUrl"
       		value="/sso?login_error=1" />
       	<property name="defaultTargetUrl" value="/cas" />
       </bean>
       
       <!-- add this to handle a logout request from the CAS server -->
       <bean id="casSingleSignOutFilter"
       	class="org.jasig.cas.client.session.SingleSignOutFilter" />

</beans>
